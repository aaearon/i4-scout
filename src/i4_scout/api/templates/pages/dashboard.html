{% extends "base.html" %}

{% block title %}Dashboard - i4-scout{% endblock %}

{% block content %}
<h1>Dashboard</h1>

<!-- Market Velocity Widget - full width -->
<section class="dashboard-grid-full">
    <div
        id="market-velocity"
        hx-get="/partials/market-velocity"
        hx-trigger="load"
        hx-swap="innerHTML"
    >
        <article class="widget">
            <div class="widget-loading"><span class="spinner"></span> Loading market data...</div>
        </article>
    </div>
</section>

<!-- Two column grid for widgets -->
<div class="dashboard-grid">
    <!-- Price Drops Widget -->
    <section>
        <div
            id="price-drops"
            hx-get="/partials/price-drops"
            hx-trigger="load"
            hx-swap="innerHTML"
        >
            <article class="widget">
                <div class="widget-loading"><span class="spinner"></span> Loading price drops...</div>
            </article>
        </div>
    </section>

    <!-- Near Miss Widget -->
    <section>
        <div
            id="near-miss"
            hx-get="/partials/near-miss"
            hx-trigger="load"
            hx-swap="innerHTML"
        >
            <article class="widget">
                <div class="widget-loading"><span class="spinner"></span> Loading near-miss listings...</div>
            </article>
        </div>
    </section>

    <!-- Feature Rarity Widget -->
    <section>
        <div
            id="feature-rarity"
            hx-get="/partials/feature-rarity"
            hx-trigger="load"
            hx-swap="innerHTML"
        >
            <article class="widget">
                <div class="widget-loading"><span class="spinner"></span> Loading feature data...</div>
            </article>
        </div>
    </section>

    <!-- Favorites Widget -->
    <section>
        <div id="favorites-widget">
            <article class="widget favorites-widget">
                <header>
                    <span class="widget-title">Your Favorites</span>
                </header>
                <div id="favorites-content">
                    <div class="widget-loading"><span class="spinner"></span> Loading favorites...</div>
                </div>
            </article>
        </div>
    </section>
</div>

<script>
// Notes popover positioning for dashboard widgets
(function() {
    const POPOVER_OFFSET_X = 15;
    const POPOVER_OFFSET_Y = 15;
    const NOTES_POPOVER_WIDTH = 400;

    function positionPopover(popover, e, width) {
        if (!popover) return;

        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const popoverWidth = width || NOTES_POPOVER_WIDTH;
        const popoverHeight = popover.offsetHeight || 200;

        let x = e.clientX + POPOVER_OFFSET_X;
        let y = e.clientY + POPOVER_OFFSET_Y;

        // Prevent popover from going off the right edge
        if (x + popoverWidth > viewportWidth - 10) {
            x = e.clientX - popoverWidth - POPOVER_OFFSET_X;
        }

        // Prevent popover from going off the bottom edge
        if (y + popoverHeight > viewportHeight - 10) {
            y = e.clientY - popoverHeight - POPOVER_OFFSET_Y;
        }

        // Ensure minimum positions
        x = Math.max(10, x);
        y = Math.max(10, y);

        popover.style.left = x + 'px';
        popover.style.top = y + 'px';
    }

    // Position notes popover on mousemove
    document.addEventListener('mousemove', function(e) {
        const notesIndicator = e.target.closest('.notes-indicator');
        if (notesIndicator) {
            const notesPopover = notesIndicator.nextElementSibling;
            if (notesPopover && notesPopover.classList.contains('notes-popover')) {
                positionPopover(notesPopover, e, NOTES_POPOVER_WIDTH);
            }
        }
    });
})();

// Load favorites from localStorage and fetch their details
document.addEventListener('DOMContentLoaded', function() {
    const favoritesContent = document.getElementById('favorites-content');
    const storedFavorites = localStorage.getItem('i4scout_favorites');

    if (storedFavorites) {
        try {
            const favorites = JSON.parse(storedFavorites);
            if (Array.isArray(favorites) && favorites.length > 0) {
                // Fetch favorites via HTMX
                const ids = favorites.join(',');
                htmx.ajax('GET', '/partials/favorites?ids=' + encodeURIComponent(ids), {
                    target: '#favorites-widget',
                    swap: 'innerHTML'
                });
            } else {
                // No favorites
                favoritesContent.innerHTML = `
                    <div class="widget-empty">
                        <p>No favorites yet.</p>
                        <p class="widget-hint">Click the star icon on listings to add them here.</p>
                    </div>
                `;
            }
        } catch (e) {
            favoritesContent.innerHTML = `
                <div class="widget-empty">
                    <p>No favorites yet.</p>
                    <p class="widget-hint">Click the star icon on listings to add them here.</p>
                </div>
            `;
        }
    } else {
        favoritesContent.innerHTML = `
            <div class="widget-empty">
                <p>No favorites yet.</p>
                <p class="widget-hint">Click the star icon on listings to add them here.</p>
            </div>
        `;
    }
});
</script>
{% endblock %}
