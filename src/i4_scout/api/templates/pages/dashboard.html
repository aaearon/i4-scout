{% extends "base.html" %}

{% block title %}Dashboard - i4-scout{% endblock %}

{% block content %}
<h1>Dashboard</h1>

<!-- Market Velocity Widget - full width -->
<section class="dashboard-grid-full">
    <div
        id="market-velocity"
        hx-get="/partials/market-velocity"
        hx-trigger="load"
        hx-swap="innerHTML"
    >
        <article class="widget">
            <div class="widget-loading"><span class="spinner"></span> Loading market data...</div>
        </article>
    </div>
</section>

<!-- Two column grid for widgets -->
<div class="dashboard-grid">
    <!-- Price Drops Widget -->
    <section>
        <div
            id="price-drops"
            hx-get="/partials/price-drops"
            hx-trigger="load"
            hx-swap="innerHTML"
        >
            <article class="widget">
                <div class="widget-loading"><span class="spinner"></span> Loading price drops...</div>
            </article>
        </div>
    </section>

    <!-- Near Miss Widget -->
    <section>
        <div
            id="near-miss"
            hx-get="/partials/near-miss"
            hx-trigger="load"
            hx-swap="innerHTML"
        >
            <article class="widget">
                <div class="widget-loading"><span class="spinner"></span> Loading near-miss listings...</div>
            </article>
        </div>
    </section>

    <!-- Feature Rarity Widget -->
    <section>
        <div
            id="feature-rarity"
            hx-get="/partials/feature-rarity"
            hx-trigger="load"
            hx-swap="innerHTML"
        >
            <article class="widget">
                <div class="widget-loading"><span class="spinner"></span> Loading feature data...</div>
            </article>
        </div>
    </section>

    <!-- Favorites Widget -->
    <section>
        <div id="favorites-widget">
            <article class="widget favorites-widget">
                <header>
                    <span class="widget-title">Your Favorites</span>
                </header>
                <div id="favorites-content">
                    <div class="widget-loading"><span class="spinner"></span> Loading favorites...</div>
                </div>
            </article>
        </div>
    </section>
</div>

<script>
// Load favorites from localStorage and fetch their details
document.addEventListener('DOMContentLoaded', function() {
    const favoritesContent = document.getElementById('favorites-content');
    const storedFavorites = localStorage.getItem('i4scout_favorites');

    if (storedFavorites) {
        try {
            const favorites = JSON.parse(storedFavorites);
            if (Array.isArray(favorites) && favorites.length > 0) {
                // Fetch favorites via HTMX
                const ids = favorites.join(',');
                htmx.ajax('GET', '/partials/favorites?ids=' + encodeURIComponent(ids), {
                    target: '#favorites-widget',
                    swap: 'innerHTML'
                });
            } else {
                // No favorites
                favoritesContent.innerHTML = `
                    <div class="widget-empty">
                        <p>No favorites yet.</p>
                        <p class="widget-hint">Click the star icon on listings to add them here.</p>
                    </div>
                `;
            }
        } catch (e) {
            favoritesContent.innerHTML = `
                <div class="widget-empty">
                    <p>No favorites yet.</p>
                    <p class="widget-hint">Click the star icon on listings to add them here.</p>
                </div>
            `;
        }
    } else {
        favoritesContent.innerHTML = `
            <div class="widget-empty">
                <p>No favorites yet.</p>
                <p class="widget-hint">Click the star icon on listings to add them here.</p>
            </div>
        `;
    }
});
</script>
{% endblock %}
