{% extends "base.html" %}

{% block title %}Listings - i4-scout{% endblock %}

{% block content %}
<h1>Listings</h1>

<!-- Filter form -->
{% include "components/filter_form.html" %}

<!-- Listings table -->
<div
    id="listings-table"
    hx-get="/partials/listings{% if query_string %}?{{ query_string }}{% endif %}"
    hx-trigger="load"
    hx-swap="innerHTML"
>
    <div class="empty-state">
        <p>Loading listings...</p>
    </div>
</div>

<!-- Compare bar (fixed at bottom) -->
{% include "components/compare_bar.html" %}
{% endblock %}

{% block scripts %}
<!-- Compare selection and favorites scripts -->
<script src="/static/js/compare-selection.js"></script>
<script src="/static/js/favorites.js"></script>

<script>
(function() {
    const STORAGE_KEY = 'i4scout_filters';

    // Check if we should restore filters (no query params but have stored filters)
    if (window.location.search === '') {
        const stored = sessionStorage.getItem(STORAGE_KEY);
        if (stored) {
            // Redirect to the stored filters URL
            window.location.replace('/listings?' + stored);
            return;
        }
    }

    // Save filters after HTMX updates the URL (covers form, sort headers, pagination)
    document.body.addEventListener('htmx:pushedIntoHistory', function(evt) {
        // Only save if we're on the listings page
        if (window.location.pathname === '/listings' && window.location.search) {
            sessionStorage.setItem(STORAGE_KEY, window.location.search.substring(1));
        }
    });

    // Clear filters handler
    window.clearFilters = function() {
        sessionStorage.removeItem(STORAGE_KEY);
        window.location.href = '/listings';
    };

    // Keyboard handler for table rows (accessibility)
    window.handleRowKeydown = function(event, row) {
        if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            window.location.href = row.dataset.href;
        } else if (event.key === 'Escape') {
            // Dismiss popover by blurring the row
            row.blur();
        }
    };

    // Form validation helper
    window.validateNumberRange = function(input, min, max) {
        const value = input.value;
        if (value === '') {
            input.removeAttribute('aria-invalid');
            return;
        }
        const num = parseInt(value, 10);
        const isValid = !isNaN(num) && num >= min && (max === undefined || num <= max);
        input.setAttribute('aria-invalid', !isValid);
    };

    // Remove a single filter and reload
    window.removeFilter = function(filterName) {
        const params = new URLSearchParams(window.location.search);
        params.delete(filterName);
        // Also update the form input if it exists
        const input = document.querySelector(`[name="${filterName}"]`);
        if (input) {
            if (input.type === 'checkbox') {
                input.checked = false;
            } else if (input.tagName === 'SELECT') {
                input.value = '';
            } else {
                input.value = '';
            }
        }
        // Navigate to updated URL
        const newUrl = '/listings' + (params.toString() ? '?' + params.toString() : '');
        window.location.href = newUrl;
    };

    // Remove a single option filter
    window.removeOptionFilter = function(optionName) {
        const params = new URLSearchParams(window.location.search);
        // Get all has_option values and remove the specified one
        const options = params.getAll('has_option').filter(opt => opt !== optionName);
        params.delete('has_option');
        options.forEach(opt => params.append('has_option', opt));
        // Also uncheck the checkbox in the form
        const checkboxes = document.querySelectorAll(`input[name="has_option"][value="${optionName}"]`);
        checkboxes.forEach(cb => cb.checked = false);
        // Navigate to updated URL
        const newUrl = '/listings' + (params.toString() ? '?' + params.toString() : '');
        window.location.href = newUrl;
    };

    // Popover cursor tracking
    const POPOVER_OFFSET_X = 15;
    const POPOVER_OFFSET_Y = 15;

    function positionPopover(popover, e, width) {
        if (!popover) return;

        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const popoverWidth = width || 450;
        const popoverHeight = popover.offsetHeight || 200;

        let x = e.clientX + POPOVER_OFFSET_X;
        let y = e.clientY + POPOVER_OFFSET_Y;

        // Prevent popover from going off the right edge
        if (x + popoverWidth > viewportWidth - 10) {
            x = e.clientX - popoverWidth - POPOVER_OFFSET_X;
        }

        // Prevent popover from going off the bottom edge
        if (y + popoverHeight > viewportHeight - 10) {
            y = e.clientY - popoverHeight - POPOVER_OFFSET_Y;
        }

        // Ensure minimum positions
        x = Math.max(10, x);
        y = Math.max(10, y);

        popover.style.left = x + 'px';
        popover.style.top = y + 'px';
    }

    // Use event delegation for dynamically loaded content
    document.addEventListener('mousemove', function(e) {
        const row = e.target.closest('.listing-row');
        if (!row) return;

        // Check if hovering over notes indicator
        const notesIndicator = e.target.closest('.notes-indicator');
        if (notesIndicator) {
            // Position notes popover, hide options popover
            const notesPopover = notesIndicator.nextElementSibling;
            if (notesPopover && notesPopover.classList.contains('notes-popover')) {
                positionPopover(notesPopover, e, 400);
            }
            // Hide options popover when hovering notes
            const optionsPopover = row.querySelector('.options-popover');
            if (optionsPopover) {
                optionsPopover.style.display = 'none';
            }
        } else {
            // Position options popover, restore its display
            const optionsPopover = row.querySelector('.options-popover');
            if (optionsPopover) {
                optionsPopover.style.display = '';
                positionPopover(optionsPopover, e, 450);
            }
            // Hide notes popover when not hovering notes indicator
            const notesPopovers = row.querySelectorAll('.notes-popover');
            notesPopovers.forEach(p => p.style.display = '');
        }
    });
})();
</script>
{% endblock %}
