{% extends "base.html" %}

{% block title %}Listings - i4-scout{% endblock %}

{% block content %}
<h1>Listings</h1>

<!-- Filter form -->
{% include "components/filter_form.html" %}

<!-- Listings table -->
<div
    id="listings-table"
    hx-get="/partials/listings{% if query_string %}?{{ query_string }}{% endif %}"
    hx-trigger="load"
    hx-swap="innerHTML"
>
    <div class="empty-state">
        <p>Loading listings...</p>
    </div>
</div>

<!-- Compare bar (fixed at bottom) -->
{% include "components/compare_bar.html" %}
{% endblock %}

{% block scripts %}
<!-- Compare selection and favorites scripts -->
<script src="/static/js/compare-selection.js"></script>
<script src="/static/js/favorites.js"></script>

<script>
(function() {
    const STORAGE_KEY = 'i4scout_filters';

    // Check if we should restore filters (no query params but have stored filters)
    if (window.location.search === '') {
        const stored = sessionStorage.getItem(STORAGE_KEY);
        if (stored) {
            // Redirect to the stored filters URL
            window.location.replace('/listings?' + stored);
            return;
        }
    }

    // Save filters after HTMX updates the URL (covers form, sort headers, pagination)
    document.body.addEventListener('htmx:pushedIntoHistory', function(evt) {
        // Only save if we're on the listings page
        if (window.location.pathname === '/listings' && window.location.search) {
            sessionStorage.setItem(STORAGE_KEY, window.location.search.substring(1));
        }
    });

    // Clear filters handler
    window.clearFilters = function() {
        sessionStorage.removeItem(STORAGE_KEY);
        window.location.href = '/listings';
    };

    // Options popover cursor tracking
    const POPOVER_OFFSET_X = 15;
    const POPOVER_OFFSET_Y = 15;

    function positionPopover(popover, e) {
        if (!popover) return;

        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const popoverWidth = 450;
        const popoverHeight = popover.offsetHeight || 200;

        let x = e.clientX + POPOVER_OFFSET_X;
        let y = e.clientY + POPOVER_OFFSET_Y;

        // Prevent popover from going off the right edge
        if (x + popoverWidth > viewportWidth - 10) {
            x = e.clientX - popoverWidth - POPOVER_OFFSET_X;
        }

        // Prevent popover from going off the bottom edge
        if (y + popoverHeight > viewportHeight - 10) {
            y = e.clientY - popoverHeight - POPOVER_OFFSET_Y;
        }

        // Ensure minimum positions
        x = Math.max(10, x);
        y = Math.max(10, y);

        popover.style.left = x + 'px';
        popover.style.top = y + 'px';
    }

    // Use event delegation for dynamically loaded content
    document.addEventListener('mousemove', function(e) {
        const row = e.target.closest('.listing-row');
        if (row) {
            const popover = row.querySelector('.options-popover');
            positionPopover(popover, e);
        }
    });
})();
</script>
{% endblock %}
