<form
    class="filter-form filter-form-structured"
    hx-get="/partials/listings"
    hx-target="#listings-table"
    hx-trigger="submit, change from:select, change from:input[type='checkbox']:not(#favorites-only), change from:input[type='radio'], input changed delay:300ms from:input[type='number'], input changed delay:400ms from:input[type='search']"
    hx-swap="innerHTML"
    hx-indicator="#filter-indicator"
>
    <!-- Quick Filters (toggle row) -->
    <div class="filter-section filter-toggles">
        <label class="filter-toggle">
            <input
                type="checkbox"
                name="qualified_only"
                value="true"
                {% if filters.qualified_only %}checked{% endif %}
            >
            <span>Qualified</span>
        </label>
        <label class="filter-toggle">
            <input
                type="checkbox"
                id="favorites-only"
                onchange="filterFavoritesOnly(this)"
            >
            <span>Favorites<span id="favorites-count"></span></span>
        </label>
        <label class="filter-toggle">
            <input
                type="checkbox"
                name="has_issue"
                value="true"
                {% if filters.has_issue %}checked{% endif %}
            >
            <span>Has Issues</span>
        </label>
        <label class="filter-toggle">
            <input
                type="checkbox"
                name="has_price_change"
                value="true"
                {% if filters.has_price_change %}checked{% endif %}
            >
            <span>Price Change</span>
        </label>
        <label class="filter-toggle">
            <input
                type="checkbox"
                name="recently_updated"
                value="true"
                {% if filters.recently_updated %}checked{% endif %}
            >
            <span>Recently Updated</span>
        </label>
    </div>

    <!-- Vehicle + Location Columns -->
    <div class="filter-columns">
        <!-- Vehicle Section -->
        <div class="filter-column">
            <div class="filter-section-label">Vehicle</div>
            <div class="filter-range">
                <input
                    type="number"
                    name="price_min"
                    id="price_min"
                    min="0"
                    step="1"
                    placeholder="Price min"
                    value="{{ filters.price_min if filters.price_min else '' }}"
                    oninput="validateNumberRange(this, 0)"
                >
                <span class="range-separator">-</span>
                <input
                    type="number"
                    name="price_max"
                    id="price_max"
                    min="0"
                    step="1"
                    placeholder="Price max"
                    value="{{ filters.price_max if filters.price_max else '' }}"
                    oninput="validateNumberRange(this, 0)"
                >
            </div>
            <div class="filter-row">
                <input
                    type="number"
                    name="min_score"
                    id="min_score"
                    min="0"
                    max="100"
                    step="1"
                    placeholder="Min score (0-100)"
                    value="{{ filters.min_score if filters.min_score else '' }}"
                    oninput="validateNumberRange(this, 0, 100)"
                >
            </div>
            <div class="filter-row">
                <input
                    type="number"
                    name="mileage_max"
                    id="mileage_max"
                    min="0"
                    step="1"
                    placeholder="Max mileage (km)"
                    value="{{ filters.mileage_max if filters.mileage_max else '' }}"
                    oninput="validateNumberRange(this, 0)"
                >
            </div>
            <div class="filter-row">
                <input
                    type="number"
                    name="year_min"
                    id="year_min"
                    min="2015"
                    max="2030"
                    placeholder="Min year (2015-2030)"
                    value="{{ filters.year_min if filters.year_min else '' }}"
                    oninput="validateNumberRange(this, 2015, 2030)"
                >
            </div>
        </div>

        <!-- Location Section -->
        <div class="filter-column">
            <div class="filter-section-label">Location & Status</div>
            <div class="filter-row">
                <select name="source" id="source">
                    <option value="">All Sources</option>
                    <option value="autoscout24_de" {% if filters.source == 'autoscout24_de' %}selected{% endif %}>AutoScout24 DE</option>
                    <option value="autoscout24_nl" {% if filters.source == 'autoscout24_nl' %}selected{% endif %}>AutoScout24 NL</option>
                </select>
            </div>
            <div class="filter-row">
                <select name="country" id="country">
                    <option value="">Any Country</option>
                    <option value="D" {% if filters.country == 'D' %}selected{% endif %}>Germany (D)</option>
                    <option value="NL" {% if filters.country == 'NL' %}selected{% endif %}>Netherlands (NL)</option>
                    <option value="B" {% if filters.country == 'B' %}selected{% endif %}>Belgium (B)</option>
                    <option value="A" {% if filters.country == 'A' %}selected{% endif %}>Austria (A)</option>
                    <option value="L" {% if filters.country == 'L' %}selected{% endif %}>Luxembourg (L)</option>
                    <option value="F" {% if filters.country == 'F' %}selected{% endif %}>France (F)</option>
                    <option value="I" {% if filters.country == 'I' %}selected{% endif %}>Italy (I)</option>
                    <option value="E" {% if filters.country == 'E' %}selected{% endif %}>Spain (E)</option>
                    <option value="CH" {% if filters.country == 'CH' %}selected{% endif %}>Switzerland (CH)</option>
                </select>
            </div>
            <div class="filter-row">
                <select name="status" id="status">
                    <option value="">All Status</option>
                    <option value="active" {% if filters.status == 'active' %}selected{% endif %}>Active</option>
                    <option value="delisted" {% if filters.status == 'delisted' %}selected{% endif %}>Delisted</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Search Section -->
    <div class="filter-section filter-search">
        <input
            type="search"
            name="search"
            id="search"
            placeholder="Search title/description..."
            value="{{ filters.search if filters.search else '' }}"
        >
    </div>

    <!-- Options Filter Section -->
    <div class="filter-section filter-options-section">
        <details class="options-filter-details" {% if filters.has_options %}open{% endif %}>
            <summary>
                <span class="options-filter-label">Filter by Options</span>
                {% if filters.has_options %}
                <span class="filter-count">({{ filters.has_options|length }})</span>
                {% endif %}
            </summary>

            <div class="options-filter-content">
                <div class="options-match-mode">
                    <label>
                        <input type="radio" name="options_match" value="all"
                            {% if filters.options_match != 'any' %}checked{% endif %}>
                        Has ALL
                    </label>
                    <label>
                        <input type="radio" name="options_match" value="any"
                            {% if filters.options_match == 'any' %}checked{% endif %}>
                        Has ANY
                    </label>
                </div>

                {% if options_config %}
                <div class="options-section">
                    <strong>Required</strong>
                    <div class="options-checkbox-grid">
                        {% for opt in options_config.required %}
                        <label class="option-checkbox">
                            <input type="checkbox" name="has_option" value="{{ opt.name }}"
                                {% if filters.has_options and opt.name in filters.has_options %}checked{% endif %}>
                            {{ opt.name }}
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <div class="options-section">
                    <strong>Nice-to-have</strong>
                    <div class="options-checkbox-grid">
                        {% for opt in options_config.nice_to_have %}
                        <label class="option-checkbox">
                            <input type="checkbox" name="has_option" value="{{ opt.name }}"
                                {% if filters.has_options and opt.name in filters.has_options %}checked{% endif %}>
                            {{ opt.name }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </details>
    </div>

    <!-- Sort + Actions Bar -->
    <div class="filter-actions">
        <select name="sort_by" id="sort_by" class="sort-select">
            <option value="first_seen" {% if filters.sort_by == 'first_seen' or not filters.sort_by %}selected{% endif %}>Date Added</option>
            <option value="price" {% if filters.sort_by == 'price' %}selected{% endif %}>Price</option>
            <option value="mileage" {% if filters.sort_by == 'mileage' %}selected{% endif %}>Mileage</option>
            <option value="score" {% if filters.sort_by == 'score' %}selected{% endif %}>Score</option>
        </select>
        <select name="sort_order" id="sort_order" class="sort-select">
            <option value="desc" {% if filters.sort_order == 'desc' or not filters.sort_order %}selected{% endif %}>Desc</option>
            <option value="asc" {% if filters.sort_order == 'asc' %}selected{% endif %}>Asc</option>
        </select>
        <button type="submit">
            Apply
            <span id="filter-indicator" class="htmx-indicator spinner"></span>
        </button>
        <button type="button" class="secondary outline" onclick="clearFilters()">
            Clear
        </button>
        <div class="export-dropdown">
            <button type="button" class="secondary outline" onclick="toggleExportMenu(this)">
                Export
            </button>
            <div class="export-menu" style="display: none;">
                <a href="#" onclick="exportListings('csv'); return false;">Export CSV</a>
                <a href="#" onclick="exportListings('json'); return false;">Export JSON</a>
            </div>
        </div>
    </div>
</form>

<script>
function toggleExportMenu(btn) {
    const menu = btn.nextElementSibling;
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

function exportListings(format) {
    // Build query string from current filter form values
    const form = document.querySelector('.filter-form');
    const formData = new FormData(form);
    const params = new URLSearchParams();

    // Add format
    params.set('format', format);

    // Add all form values
    for (const [key, value] of formData.entries()) {
        if (value && key !== 'has_option') {
            params.set(key, value);
        }
    }

    // Handle has_option (multiple values)
    const hasOptions = formData.getAll('has_option');
    hasOptions.forEach(opt => params.append('has_option', opt));

    // Trigger download
    window.location.href = '/api/export/listings?' + params.toString();

    // Close the menu
    document.querySelectorAll('.export-menu').forEach(m => m.style.display = 'none');
}

// Close export menu when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.export-dropdown')) {
        document.querySelectorAll('.export-menu').forEach(m => m.style.display = 'none');
    }
});
</script>
