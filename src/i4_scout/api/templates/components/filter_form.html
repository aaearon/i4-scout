<form
    class="filter-form"
    hx-get="/partials/listings"
    hx-target="#listings-table"
    hx-trigger="submit"
    hx-swap="innerHTML"
    hx-push-url="/listings"
    hx-indicator="#filter-indicator"
>
    <div class="filter-group">
        <label for="source">Source</label>
        <select name="source" id="source">
            <option value="">All Sources</option>
            <option value="autoscout24_de" {% if filters.source == 'autoscout24_de' %}selected{% endif %}>AutoScout24 DE</option>
            <option value="autoscout24_nl" {% if filters.source == 'autoscout24_nl' %}selected{% endif %}>AutoScout24 NL</option>
        </select>
    </div>

    <div class="filter-group">
        <label for="qualified_only">
            <input
                type="checkbox"
                name="qualified_only"
                id="qualified_only"
                value="true"
                {% if filters.qualified_only %}checked{% endif %}
            >
            Qualified Only
        </label>
    </div>

    <div class="filter-group">
        <label for="favorites-only">
            <input
                type="checkbox"
                id="favorites-only"
                onchange="filterFavoritesOnly(this)"
            >
            Favorites Only<span id="favorites-count"></span>
        </label>
    </div>

    <div class="filter-group">
        <label for="has_issue">
            <input
                type="checkbox"
                name="has_issue"
                id="has_issue"
                value="true"
                {% if filters.has_issue %}checked{% endif %}
            >
            Has Issues
        </label>
    </div>

    <div class="filter-group">
        <label for="min_score">Min Score</label>
        <input
            type="number"
            name="min_score"
            id="min_score"
            min="0"
            max="100"
            step="1"
            placeholder="0-100"
            value="{{ filters.min_score if filters.min_score else '' }}"
        >
    </div>

    <div class="filter-group">
        <label for="price_min">Price Min</label>
        <input
            type="number"
            name="price_min"
            id="price_min"
            min="0"
            step="1"
            placeholder="EUR"
            value="{{ filters.price_min if filters.price_min else '' }}"
        >
    </div>

    <div class="filter-group">
        <label for="price_max">Price Max</label>
        <input
            type="number"
            name="price_max"
            id="price_max"
            min="0"
            step="1"
            placeholder="EUR"
            value="{{ filters.price_max if filters.price_max else '' }}"
        >
    </div>

    <div class="filter-group">
        <label for="mileage_max">Mileage Max</label>
        <input
            type="number"
            name="mileage_max"
            id="mileage_max"
            min="0"
            step="1"
            placeholder="km"
            value="{{ filters.mileage_max if filters.mileage_max else '' }}"
        >
    </div>

    <div class="filter-group">
        <label for="year_min">Reg Year Min</label>
        <input
            type="number"
            name="year_min"
            id="year_min"
            min="2015"
            max="2030"
            placeholder="YYYY"
            value="{{ filters.year_min if filters.year_min else '' }}"
        >
    </div>

    <div class="filter-group">
        <label for="country">Country</label>
        <input
            type="text"
            name="country"
            id="country"
            maxlength="5"
            placeholder="D, NL, B..."
            value="{{ filters.country if filters.country else '' }}"
        >
    </div>

    <div class="filter-group">
        <label for="search">Search</label>
        <input
            type="search"
            name="search"
            id="search"
            placeholder="Search title/description"
            value="{{ filters.search if filters.search else '' }}"
            hx-get="/partials/listings"
            hx-target="#listings-table"
            hx-trigger="input changed delay:500ms"
            hx-push-url="/listings"
            hx-include="closest form"
        >
    </div>

    <div class="filter-group filter-group-wide">
        <details class="options-filter-details" {% if filters.has_options %}open{% endif %}>
            <summary>
                <span class="options-filter-label">Filter by Options</span>
                {% if filters.has_options %}
                <span class="filter-count">({{ filters.has_options|length }})</span>
                {% endif %}
            </summary>

            <div class="options-filter-content">
                <div class="options-match-mode">
                    <label>
                        <input type="radio" name="options_match" value="all"
                            {% if filters.options_match != 'any' %}checked{% endif %}>
                        Has ALL
                    </label>
                    <label>
                        <input type="radio" name="options_match" value="any"
                            {% if filters.options_match == 'any' %}checked{% endif %}>
                        Has ANY
                    </label>
                </div>

                {% if options_config %}
                <div class="options-section">
                    <strong>Required</strong>
                    <div class="options-checkbox-grid">
                        {% for opt in options_config.required %}
                        <label class="option-checkbox">
                            <input type="checkbox" name="has_option" value="{{ opt.name }}"
                                {% if filters.has_options and opt.name in filters.has_options %}checked{% endif %}>
                            {{ opt.name }}
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <div class="options-section">
                    <strong>Nice-to-have</strong>
                    <div class="options-checkbox-grid">
                        {% for opt in options_config.nice_to_have %}
                        <label class="option-checkbox">
                            <input type="checkbox" name="has_option" value="{{ opt.name }}"
                                {% if filters.has_options and opt.name in filters.has_options %}checked{% endif %}>
                            {{ opt.name }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </details>
    </div>

    <div class="filter-group">
        <label for="sort_by">Sort By</label>
        <select name="sort_by" id="sort_by">
            <option value="first_seen" {% if filters.sort_by == 'first_seen' or not filters.sort_by %}selected{% endif %}>Date Added</option>
            <option value="price" {% if filters.sort_by == 'price' %}selected{% endif %}>Price</option>
            <option value="mileage" {% if filters.sort_by == 'mileage' %}selected{% endif %}>Mileage</option>
            <option value="score" {% if filters.sort_by == 'score' %}selected{% endif %}>Score</option>
        </select>
    </div>

    <div class="filter-group">
        <label for="sort_order">Order</label>
        <select name="sort_order" id="sort_order">
            <option value="desc" {% if filters.sort_order == 'desc' or not filters.sort_order %}selected{% endif %}>Descending</option>
            <option value="asc" {% if filters.sort_order == 'asc' %}selected{% endif %}>Ascending</option>
        </select>
    </div>

    <div class="filter-group filter-buttons">
        <button type="submit">
            Apply
            <span id="filter-indicator" class="htmx-indicator spinner"></span>
        </button>
        <button type="button" class="secondary outline" onclick="clearFilters()">
            Clear
        </button>
    </div>
</form>
