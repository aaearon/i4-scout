<tr
    class="listing-row"
    data-href="/listings/{{ listing.id }}"
    data-listing-id="{{ listing.id }}"
    onclick="window.location.href='/listings/{{ listing.id }}'"
    onkeydown="handleRowKeydown(event, this)"
    tabindex="0"
    role="link"
    aria-label="View listing {{ listing.id }}: {{ listing.title }}"
    aria-describedby="popover-{{ listing.id }}"
    hx-get="/partials/listing/{{ listing.id }}/options-summary"
    hx-trigger="mouseenter once, focus once"
    hx-target="find .options-popover"
    hx-swap="innerHTML"
>
    <td onclick="event.stopPropagation();">
        <input type="checkbox" class="listing-checkbox"
               data-listing-id="{{ listing.id }}"
               data-listing-title="{{ listing.title }}"
               data-listing-price="{{ listing.price or '' }}"
               onchange="toggleSelection(this)">
    </td>
    <td onclick="event.stopPropagation();" class="favorite-cell">
        <button type="button" class="favorite-btn" data-listing-id="{{ listing.id }}" onclick="toggleFavorite({{ listing.id }}, event)" title="Add to favorites" aria-pressed="false">&#x2606;</button>
    </td>
    <td>{{ listing.id }}</td>
    <td class="title-cell" title="{{ listing.title }}">
        <span class="title-text">{{ listing.title }}</span>
        <span class="title-actions">
            {% if listing.status == "delisted" %}<span class="status-icon delisted" title="Delisted ({{ listing.days_on_market }} days on market)">&#x2612;</span>{% endif %}
            {% if listing.has_issue %}<span class="issue-icon" title="Has issue">&#x26A0;</span>{% endif %}
            {# Show "updated" badge only for listings with recent price changes (within 24h) #}
            {% if listing.last_price_change_at %}
                {% set change_hours_ago = ((now - listing.last_price_change_at).total_seconds() / 3600) | int %}
                {% if change_hours_ago < 24 %}<span class="updated-icon" title="Price changed {{ change_hours_ago }}h ago">&#x21BB;</span>{% endif %}
            {% endif %}
            {% if listing.document_count > 0 %}<span class="document-icon" title="Has dealer document">&#x1F4C4;</span>{% endif %}
            {% if listing.notes_count > 0 %}
                <span
                    class="notes-indicator"
                    hx-get="/partials/listing/{{ listing.id }}/notes-summary"
                    hx-trigger="mouseenter once, focus once"
                    hx-target="next .notes-popover"
                    hx-swap="innerHTML"
                    title="{{ listing.notes_count }} note{% if listing.notes_count != 1 %}s{% endif %}"
                    tabindex="0"
                >({{ listing.notes_count }})</span>
                <div class="notes-popover" role="tooltip" aria-hidden="true">
                    <span class="spinner"></span> Loading...
                </div>
            {% endif %}
            {% if listing.price_change_count > 0 %}
                {% if listing.price_change < 0 %}
                    <span class="price-change-icon price-drop" title="Price dropped {{ "{:,}".format(listing.price_change|abs) }}">&#x2193; -{{ "{:,}".format(listing.price_change|abs) }}</span>
                {% elif listing.price_change > 0 %}
                    <span class="price-change-icon price-increase" title="Price increased {{ "{:,}".format(listing.price_change) }}">&#x2191; +{{ "{:,}".format(listing.price_change) }}</span>
                {% endif %}
            {% endif %}
            <a href="/listings/{{ listing.id }}" target="_blank" rel="noopener" onclick="event.stopPropagation();" class="action-link" title="Open details in new tab">&#x29C9;</a>
            <a href="{{ listing.url }}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();" class="action-link action-link-external" title="Open on AutoScout24">&#x2197;</a>
        </span>
        <div
            class="options-popover"
            role="tooltip"
            id="popover-{{ listing.id }}"
            aria-hidden="true"
        >
            <span class="spinner"></span> Loading...
        </div>
    </td>
    <td style="text-align: right;">
        {% if listing.price %}
            {{ "{:,.0f}".format(listing.price) }}
        {% else %}
            --
        {% endif %}
    </td>
    <td style="text-align: right;">
        {% if listing.mileage_km %}
            {{ "{:,.0f}".format(listing.mileage_km) }}
        {% else %}
            --
        {% endif %}
    </td>
    <td style="text-align: right;">
        {% if listing.match_score is not none %}
            {{ "{:.1f}".format(listing.match_score) }}
        {% else %}
            --
        {% endif %}
    </td>
    <td>
        {% if listing.is_qualified %}
        <span class="badge badge-qualified">Yes</span>
        {% else %}
        <span class="badge badge-not-qualified">No</span>
        {% endif %}
    </td>
    <td>{{ listing.first_registration.strftime('%m/%Y') if listing.first_registration else '--' }}</td>
    <td>{{ listing.first_seen_at.strftime('%Y-%m-%d') if listing.first_seen_at else '--' }}</td>
</tr>
