<div class="detail-header">
    <div>
        <h1>{{ listing.title }}</h1>
        <div class="badge-row">
            {% if listing.is_qualified %}
            <span class="badge badge-qualified">Qualified</span>
            {% else %}
            <span class="badge badge-not-qualified">Not Qualified</span>
            {% endif %}
            {% if listing.has_issue %}
            <span class="badge badge-issue">Has Issue</span>
            {% endif %}
            {% if listing.status == "delisted" %}
            <span class="badge badge-delisted">Delisted</span>
            {% else %}
            <span class="badge badge-active">Active</span>
            {% endif %}
            <span class="days-on-market">{{ listing.days_on_market }} days on market</span>
        </div>
    </div>
    <div class="detail-actions">
        <button
            type="button"
            id="issue-toggle-btn"
            class="issue-toggle-btn{% if listing.has_issue %} has-issue{% endif %}"
            hx-patch="/partials/listing/{{ listing.id }}/issue"
            hx-swap="outerHTML"
            hx-vals='{"has_issue": {{ 'false' if listing.has_issue else 'true' }}}'
            title="{{ 'Clear issue flag' if listing.has_issue else 'Mark as having an issue' }}"
        >
            {% if listing.has_issue %}&#x2713; Issue Marked{% else %}&#x26A0; Mark Issue{% endif %}
        </button>
        <button type="button" class="favorite-btn favorite-btn-large" data-listing-id="{{ listing.id }}" onclick="toggleFavorite({{ listing.id }}, event)" title="Add to favorites" aria-pressed="false">&#x2606; Favorite</button>
        <a href="{{ listing.url }}" target="_blank" rel="noopener noreferrer">
            <button class="secondary">View on Source</button>
        </a>
    </div>
</div>

<div class="detail-table">
    <div class="detail-row">
        <span class="label">Price</span>
        <span class="value">{% if listing.price %}â‚¬{{ "{:,.0f}".format(listing.price) }}{% else %}N/A{% endif %}</span>
    </div>
    <div class="detail-row">
        <span class="label">Mileage</span>
        <span class="value">{% if listing.mileage_km %}{{ "{:,.0f}".format(listing.mileage_km) }} km{% else %}N/A{% endif %}</span>
    </div>
    <div class="detail-row">
        <span class="label">First Registration</span>
        <span class="value">{{ listing.first_registration.strftime('%m/%Y') if listing.first_registration else 'N/A' }}</span>
    </div>
    <div class="detail-row">
        <span class="label">Match Score</span>
        <span class="value">{% if listing.match_score is not none %}{{ "{:.1f}".format(listing.match_score) }}{% else %}--{% endif %}</span>
    </div>
    <div class="detail-row">
        <span class="label">Location</span>
        <span class="value">{% if listing.location_city %}<a href="/listings?location_city={{ listing.location_city | urlencode }}" class="filter-link">{{ listing.location_city }}</a>{% else %}--{% endif %}{% if listing.location_country %}, {{ listing.location_country }}{% endif %}</span>
    </div>
    <div class="detail-row">
        <span class="label">Dealer</span>
        <span class="value">{% if listing.dealer_name %}<a href="/listings?dealer_name={{ listing.dealer_name | urlencode }}" class="filter-link">{{ listing.dealer_name }}</a>{% else %}--{% endif %}{% if listing.dealer_type %} <small>({{ listing.dealer_type }})</small>{% endif %}</span>
    </div>
    <div class="detail-row">
        <span class="label">Exterior Color</span>
        <span class="value">{{ listing.exterior_color or '--' }}</span>
    </div>
    <div class="detail-row">
        <span class="label">Interior</span>
        <span class="value">{{ listing.interior_color or '--' }}{% if listing.interior_material %} / {{ listing.interior_material }}{% endif %}</span>
    </div>
    <div class="detail-row">
        <span class="label">Source</span>
        <span class="value"><span class="badge badge-source">{{ listing.source.value if listing.source else '--' }}</span></span>
    </div>
    <div class="detail-row">
        <span class="label">First Seen</span>
        <span class="value">{{ listing.first_seen_at.strftime('%Y-%m-%d') if listing.first_seen_at else '--' }}</span>
    </div>
    <div class="detail-row">
        <span class="label">Last Seen</span>
        <span class="value">{{ listing.last_seen_at.strftime('%Y-%m-%d') if listing.last_seen_at else '--' }}</span>
    </div>
</div>

<!-- Photo Gallery -->
<div
    id="gallery-section"
    hx-get="/partials/listing/{{ listing.id }}/gallery"
    hx-trigger="load"
    hx-swap="innerHTML"
>
    <article class="photo-gallery-section">
        <header>
            Photos
            <span class="htmx-indicator"><span class="spinner"></span></span>
        </header>
        <div class="empty-state">
            <p>Loading photos...</p>
        </div>
    </article>
</div>

{% if options_status %}
<!-- Required Options -->
<article>
    <header>Required Options ({{ options_status.required|selectattr('has')|list|length }} / {{ options_status.required|length }})</header>
    {% if options_status.required %}
    <div class="options-card-grid">
        {% for opt in options_status.required %}
        <div class="option-card {% if opt.has %}option-card-has{% else %}option-card-missing{% endif %}{% if opt.in_pdf %} option-card-pdf{% endif %}">
            <span class="option-icon">{% if opt.has %}&#10003;{% else %}&#10007;{% endif %}</span>
            <span class="option-name">
                {{ opt.name }}
                {% if opt.in_pdf %}<span class="badge badge-pdf" title="Found in dealer PDF">PDF</span>{% endif %}
            </span>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="empty-state">No required options configured.</p>
    {% endif %}
</article>

<!-- Nice-to-Have Options -->
<article>
    <header>Nice-to-Have Options ({{ options_status.nice_to_have|selectattr('has')|list|length }} / {{ options_status.nice_to_have|length }})</header>
    {% if options_status.nice_to_have %}
    <div class="options-card-grid">
        {% for opt in options_status.nice_to_have %}
        <div class="option-card {% if opt.has %}option-card-nice-has{% else %}option-card-nice-missing{% endif %}{% if opt.in_pdf %} option-card-pdf{% endif %}">
            <span class="option-icon">{% if opt.has %}&#10003;{% else %}&#10007;{% endif %}</span>
            <span class="option-name">
                {{ opt.name }}
                {% if opt.in_pdf %}<span class="badge badge-pdf" title="Found in dealer PDF">PDF</span>{% endif %}
            </span>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="empty-state">No nice-to-have options configured.</p>
    {% endif %}
</article>

<!-- Dealbreakers -->
{% if options_status.dealbreakers %}
<article class="dealbreakers-section">
    <header>Dealbreakers</header>
    {% set has_dealbreaker = listing.dealbreaker_found is defined and listing.dealbreaker_found %}
    {% if has_dealbreaker %}
    <div class="alert alert-error">
        Dealbreaker detected: {{ listing.dealbreaker_found }}
    </div>
    {% else %}
    <p class="no-dealbreakers">No dealbreakers found</p>
    {% endif %}
    <details>
        <summary>View dealbreaker keywords ({{ options_status.dealbreakers|length }})</summary>
        <ul class="dealbreaker-list">
            {% for db in options_status.dealbreakers %}
            <li>{{ db }}</li>
            {% endfor %}
        </ul>
    </details>
</article>
{% endif %}
{% elif listing.matched_options %}
<!-- Fallback to simple list if options_status not provided -->
<article>
    <header>Matched Options</header>
    <ul class="options-list">
        {% for option in listing.matched_options %}
        <li>{{ option }}</li>
        {% endfor %}
    </ul>
</article>
{% endif %}

<!-- Price History -->
<article>
    <header>
        Price History
        <span id="price-indicator" class="htmx-indicator"><span class="spinner"></span></span>
    </header>
    <div
        id="price-history"
        hx-get="/partials/listing/{{ listing.id }}/price-chart"
        hx-trigger="load"
        hx-swap="innerHTML"
        hx-indicator="#price-indicator"
    >
        <div class="empty-state">
            <p>Loading price history...</p>
        </div>
    </div>
</article>

<!-- Dealer Document -->
<div
    id="document-section"
    hx-get="/partials/listing/{{ listing.id }}/document"
    hx-trigger="load"
    hx-swap="innerHTML"
>
    <article class="document-section">
        <header>
            Dealer Document
            <span class="htmx-indicator"><span class="spinner"></span></span>
        </header>
        <div class="empty-state">
            <p>Loading document section...</p>
        </div>
    </article>
</div>

<!-- Notes Section -->
<div
    id="notes-section"
    hx-get="/partials/listing/{{ listing.id }}/notes"
    hx-trigger="load"
    hx-swap="innerHTML"
>
    <article class="notes-section">
        <header>
            Notes
            <span class="htmx-indicator"><span class="spinner"></span></span>
        </header>
        <div class="empty-state">
            <p>Loading notes...</p>
        </div>
    </article>
</div>

<!-- Delete Button -->
<article>
    <header>Actions</header>
    <button
        class="secondary"
        hx-delete="/api/listings/{{ listing.id }}"
        hx-confirm="Are you sure you want to delete this listing?"
        hx-target="body"
        hx-on::after-request="if(event.detail.successful) window.location.href='/listings';"
    >
        Delete Listing
    </button>
</article>
