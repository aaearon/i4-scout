<div class="detail-header">
    <div>
        <h1>{{ listing.title }}</h1>
        {% if listing.is_qualified %}
        <span class="badge badge-qualified">Qualified</span>
        {% else %}
        <span class="badge badge-not-qualified">Not Qualified</span>
        {% endif %}
    </div>
    <div class="detail-actions">
        <button type="button" class="favorite-btn favorite-btn-large" data-listing-id="{{ listing.id }}" onclick="toggleFavorite({{ listing.id }}, event)" title="Add to favorites" aria-pressed="false">&#x2606; Favorite</button>
        <a href="{{ listing.url }}" target="_blank" rel="noopener noreferrer">
            <button class="secondary">View on Source</button>
        </a>
    </div>
</div>

<div class="detail-grid">
    <div class="detail-item">
        <div class="label">Price</div>
        <div class="value">
            {% if listing.price %}
                {{ "{:,.0f}".format(listing.price) }}
            {% else %}
                N/A
            {% endif %}
        </div>
    </div>
    <div class="detail-item">
        <div class="label">Mileage</div>
        <div class="value">
            {% if listing.mileage_km %}
                {{ "{:,.0f}".format(listing.mileage_km) }} km
            {% else %}
                N/A
            {% endif %}
        </div>
    </div>
    <div class="detail-item">
        <div class="label">First Registration</div>
        <div class="value">{{ listing.first_registration.strftime('%m/%Y') if listing.first_registration else 'N/A' }}</div>
    </div>
    <div class="detail-item">
        <div class="label">Match Score</div>
        <div class="value">
            {% if listing.match_score is not none %}
                {{ "{:.1f}".format(listing.match_score) }}
            {% else %}
                --
            {% endif %}
        </div>
    </div>
    <div class="detail-item">
        <div class="label">Location</div>
        <div class="value">
            {{ listing.location_city or '--' }}{% if listing.location_country %}, {{ listing.location_country }}{% endif %}
        </div>
    </div>
    <div class="detail-item">
        <div class="label">Dealer</div>
        <div class="value">
            {{ listing.dealer_name or '--' }}
            {% if listing.dealer_type %}<br><small>({{ listing.dealer_type }})</small>{% endif %}
        </div>
    </div>
    <div class="detail-item">
        <div class="label">Source</div>
        <div class="value">
            <span class="badge badge-source">{{ listing.source.value if listing.source else '--' }}</span>
        </div>
    </div>
    <div class="detail-item">
        <div class="label">First Seen</div>
        <div class="value">{{ listing.first_seen_at.strftime('%Y-%m-%d %H:%M') if listing.first_seen_at else '--' }}</div>
    </div>
    <div class="detail-item">
        <div class="label">Last Seen</div>
        <div class="value">{{ listing.last_seen_at.strftime('%Y-%m-%d %H:%M') if listing.last_seen_at else '--' }}</div>
    </div>
</div>

{% if options_status %}
<!-- Required Options -->
<article>
    <header>Required Options ({{ options_status.required|selectattr('has')|list|length }} / {{ options_status.required|length }})</header>
    {% if options_status.required %}
    <div class="options-card-grid">
        {% for opt in options_status.required %}
        <div class="option-card {% if opt.has %}option-card-has{% else %}option-card-missing{% endif %}{% if opt.in_pdf %} option-card-pdf{% endif %}">
            <span class="option-icon">{% if opt.has %}&#10003;{% else %}&#10007;{% endif %}</span>
            <span class="option-name">
                {{ opt.name }}
                {% if opt.in_pdf %}<span class="badge badge-pdf" title="Found in dealer PDF">PDF</span>{% endif %}
            </span>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="empty-state">No required options configured.</p>
    {% endif %}
</article>

<!-- Nice-to-Have Options -->
<article>
    <header>Nice-to-Have Options ({{ options_status.nice_to_have|selectattr('has')|list|length }} / {{ options_status.nice_to_have|length }})</header>
    {% if options_status.nice_to_have %}
    <div class="options-card-grid">
        {% for opt in options_status.nice_to_have %}
        <div class="option-card {% if opt.has %}option-card-nice-has{% else %}option-card-nice-missing{% endif %}{% if opt.in_pdf %} option-card-pdf{% endif %}">
            <span class="option-icon">{% if opt.has %}&#10003;{% else %}&#10007;{% endif %}</span>
            <span class="option-name">
                {{ opt.name }}
                {% if opt.in_pdf %}<span class="badge badge-pdf" title="Found in dealer PDF">PDF</span>{% endif %}
            </span>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="empty-state">No nice-to-have options configured.</p>
    {% endif %}
</article>

<!-- Dealbreakers -->
{% if options_status.dealbreakers %}
<article class="dealbreakers-section">
    <header>Dealbreakers</header>
    {% set has_dealbreaker = listing.dealbreaker_found is defined and listing.dealbreaker_found %}
    {% if has_dealbreaker %}
    <div class="alert alert-error">
        Dealbreaker detected: {{ listing.dealbreaker_found }}
    </div>
    {% else %}
    <p class="no-dealbreakers">No dealbreakers found</p>
    {% endif %}
    <details>
        <summary>View dealbreaker keywords ({{ options_status.dealbreakers|length }})</summary>
        <ul class="dealbreaker-list">
            {% for db in options_status.dealbreakers %}
            <li>{{ db }}</li>
            {% endfor %}
        </ul>
    </details>
</article>
{% endif %}
{% elif listing.matched_options %}
<!-- Fallback to simple list if options_status not provided -->
<article>
    <header>Matched Options</header>
    <ul class="options-list">
        {% for option in listing.matched_options %}
        <li>{{ option }}</li>
        {% endfor %}
    </ul>
</article>
{% endif %}

<!-- Price History -->
<article>
    <header>
        Price History
        <span id="price-indicator" class="htmx-indicator"><span class="spinner"></span></span>
    </header>
    <div
        id="price-history"
        hx-get="/partials/listing/{{ listing.id }}/price-chart"
        hx-trigger="load"
        hx-swap="innerHTML"
        hx-indicator="#price-indicator"
    >
        <div class="empty-state">
            <p>Loading price history...</p>
        </div>
    </div>
</article>

<!-- Dealer Document -->
<div
    id="document-section"
    hx-get="/partials/listing/{{ listing.id }}/document"
    hx-trigger="load"
    hx-swap="innerHTML"
>
    <article class="document-section">
        <header>
            Dealer Document
            <span class="htmx-indicator"><span class="spinner"></span></span>
        </header>
        <div class="empty-state">
            <p>Loading document section...</p>
        </div>
    </article>
</div>

<!-- Delete Button -->
<article>
    <header>Actions</header>
    <button
        class="secondary"
        hx-delete="/api/listings/{{ listing.id }}"
        hx-confirm="Are you sure you want to delete this listing?"
        hx-target="body"
        hx-on::after-request="if(event.detail.successful) window.location.href='/listings';"
    >
        Delete Listing
    </button>
</article>
