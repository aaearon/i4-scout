{% macro sort_header(field, label, align='left') %}
{% set is_active = filters.sort_by == field %}
{% set new_order = 'asc' if (is_active and filters.sort_order == 'desc') else 'desc' %}
{% set sort_indicator = '' %}
{% if is_active %}
    {% if filters.sort_order == 'asc' %}
        {% set sort_indicator = ' &#9650;' %}
    {% else %}
        {% set sort_indicator = ' &#9660;' %}
    {% endif %}
{% endif %}
{# Use namespace to allow modification inside loops #}
{% set ns = namespace(query='sort_by=' ~ field ~ '&sort_order=' ~ new_order ~ '&limit=' ~ limit ~ '&offset=0') %}
{% if filters.source %}{% set ns.query = ns.query ~ '&source=' ~ filters.source %}{% endif %}
{% if filters.qualified_only %}{% set ns.query = ns.query ~ '&qualified_only=true' %}{% endif %}
{% if filters.has_issue %}{% set ns.query = ns.query ~ '&has_issue=true' %}{% endif %}
{% if filters.has_price_change %}{% set ns.query = ns.query ~ '&has_price_change=true' %}{% endif %}
{% if filters.recently_updated %}{% set ns.query = ns.query ~ '&recently_updated=true' %}{% endif %}
{% if filters.min_score %}{% set ns.query = ns.query ~ '&min_score=' ~ filters.min_score %}{% endif %}
{% if filters.price_min %}{% set ns.query = ns.query ~ '&price_min=' ~ filters.price_min %}{% endif %}
{% if filters.price_max %}{% set ns.query = ns.query ~ '&price_max=' ~ filters.price_max %}{% endif %}
{% if filters.mileage_max %}{% set ns.query = ns.query ~ '&mileage_max=' ~ filters.mileage_max %}{% endif %}
{% if filters.year_min %}{% set ns.query = ns.query ~ '&year_min=' ~ filters.year_min %}{% endif %}
{% if filters.country %}{% set ns.query = ns.query ~ '&country=' ~ filters.country %}{% endif %}
{% if filters.search %}{% set ns.query = ns.query ~ '&search=' ~ filters.search %}{% endif %}
{% if filters.has_options %}{% for opt in filters.has_options %}{% set ns.query = ns.query ~ '&has_option=' ~ (opt | urlencode) %}{% endfor %}{% endif %}
{% if filters.options_match %}{% set ns.query = ns.query ~ '&options_match=' ~ filters.options_match %}{% endif %}
<th
    class="sortable-header {% if is_active %}sort-active{% endif %}"
    style="cursor: pointer; {% if align == 'right' %}text-align: right;{% endif %}"
    hx-get="/partials/listings?{{ ns.query }}"
    hx-target="#listings-table"
    hx-push-url="/listings?{{ ns.query }}"
>{{ label }}{{ sort_indicator | safe }}</th>
{% endmacro %}

{% if listings %}
{# Active filter chips #}
{% set has_active_filters = filters.source or filters.qualified_only or filters.has_issue or filters.has_price_change or filters.recently_updated or filters.min_score or filters.price_min or filters.price_max or filters.mileage_max or filters.year_min or filters.country or filters.search or filters.has_options %}
{% if has_active_filters %}
<div class="active-filters" id="active-filters">
    <span class="active-filters-label">Active filters:</span>
    {% if filters.source %}
    <button type="button" class="filter-chip" onclick="removeFilter('source')" aria-label="Remove source filter">
        Source: {{ filters.source.replace('autoscout24_', '').upper() }}
        <span class="chip-remove">&times;</span>
    </button>
    {% endif %}
    {% if filters.qualified_only %}
    <button type="button" class="filter-chip filter-chip-success" onclick="removeFilter('qualified_only')" aria-label="Remove qualified only filter">
        Qualified
        <span class="chip-remove">&times;</span>
    </button>
    {% endif %}
    {% if filters.has_issue %}
    <button type="button" class="filter-chip filter-chip-danger" onclick="removeFilter('has_issue')" aria-label="Remove has issues filter">
        Has Issues
        <span class="chip-remove">&times;</span>
    </button>
    {% endif %}
    {% if filters.has_price_change %}
    <button type="button" class="filter-chip" onclick="removeFilter('has_price_change')" aria-label="Remove price change filter">
        Price Changed
        <span class="chip-remove">&times;</span>
    </button>
    {% endif %}
    {% if filters.recently_updated %}
    <button type="button" class="filter-chip filter-chip-info" onclick="removeFilter('recently_updated')" aria-label="Remove recently updated filter">
        Recently Updated
        <span class="chip-remove">&times;</span>
    </button>
    {% endif %}
    {% if filters.min_score %}
    <button type="button" class="filter-chip" onclick="removeFilter('min_score')" aria-label="Remove minimum score filter">
        Score &ge; {{ filters.min_score }}
        <span class="chip-remove">&times;</span>
    </button>
    {% endif %}
    {% if filters.price_min %}
    <button type="button" class="filter-chip" onclick="removeFilter('price_min')" aria-label="Remove minimum price filter">
        Price &ge; {{ "{:,.0f}".format(filters.price_min) }}
        <span class="chip-remove">&times;</span>
    </button>
    {% endif %}
    {% if filters.price_max %}
    <button type="button" class="filter-chip" onclick="removeFilter('price_max')" aria-label="Remove maximum price filter">
        Price &le; {{ "{:,.0f}".format(filters.price_max) }}
        <span class="chip-remove">&times;</span>
    </button>
    {% endif %}
    {% if filters.mileage_max %}
    <button type="button" class="filter-chip" onclick="removeFilter('mileage_max')" aria-label="Remove maximum mileage filter">
        Mileage &le; {{ "{:,.0f}".format(filters.mileage_max) }} km
        <span class="chip-remove">&times;</span>
    </button>
    {% endif %}
    {% if filters.year_min %}
    <button type="button" class="filter-chip" onclick="removeFilter('year_min')" aria-label="Remove minimum year filter">
        Year &ge; {{ filters.year_min }}
        <span class="chip-remove">&times;</span>
    </button>
    {% endif %}
    {% if filters.country %}
    <button type="button" class="filter-chip" onclick="removeFilter('country')" aria-label="Remove country filter">
        Country: {{ filters.country }}
        <span class="chip-remove">&times;</span>
    </button>
    {% endif %}
    {% if filters.search %}
    <button type="button" class="filter-chip" onclick="removeFilter('search')" aria-label="Remove search filter">
        "{{ filters.search[:20] }}{% if filters.search|length > 20 %}...{% endif %}"
        <span class="chip-remove">&times;</span>
    </button>
    {% endif %}
    {% if filters.has_options %}
    {% for opt in filters.has_options %}
    <button type="button" class="filter-chip filter-chip-info" onclick="removeOptionFilter('{{ opt }}')" aria-label="Remove option filter: {{ opt }}">
        {{ opt }}
        <span class="chip-remove">&times;</span>
    </button>
    {% endfor %}
    {% endif %}
    <button type="button" class="filter-chip-clear" onclick="clearFilters()" aria-label="Clear all filters">
        Clear All
    </button>
</div>
{% endif %}

<div class="pagination-info-top">
    Showing {{ offset + 1 }} - {{ offset + count }} of {{ total }} listings
</div>
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th style="width: 2.5rem;">
                    <input type="checkbox" id="select-all" title="Select all visible">
                </th>
                <th style="width: 1.5rem;" title="Favorites"></th>
                <th>ID</th>
                <th>Title</th>
                {{ sort_header('price', 'Price', 'right') }}
                {{ sort_header('mileage', 'Mileage', 'right') }}
                {{ sort_header('score', 'Score', 'right') }}
                <th>Qualified</th>
                <th>First Reg</th>
                {{ sort_header('first_seen', 'Added') }}
            </tr>
        </thead>
        <tbody>
            {% for listing in listings %}
            {% include "components/listing_row.html" %}
            {% endfor %}
        </tbody>
    </table>
</div>

{% include "components/pagination.html" %}

{% else %}
<div class="empty-state">
    <p>No listings found matching your criteria.</p>
</div>
{% endif %}
