{% macro sort_header(field, label, align='left') %}
{% set is_active = filters.sort_by == field %}
{% set new_order = 'asc' if (is_active and filters.sort_order == 'desc') else 'desc' %}
{% set sort_indicator = '' %}
{% if is_active %}
    {% if filters.sort_order == 'asc' %}
        {% set sort_indicator = ' &#9650;' %}
    {% else %}
        {% set sort_indicator = ' &#9660;' %}
    {% endif %}
{% endif %}
<th
    class="sortable-header {% if is_active %}sort-active{% endif %}"
    style="cursor: pointer; {% if align == 'right' %}text-align: right;{% endif %}"
    hx-get="/partials/listings?sort_by={{ field }}&sort_order={{ new_order }}&limit={{ limit }}&offset=0{% if filters.source %}&source={{ filters.source }}{% endif %}{% if filters.qualified_only %}&qualified_only=true{% endif %}{% if filters.min_score %}&min_score={{ filters.min_score }}{% endif %}{% if filters.price_min %}&price_min={{ filters.price_min }}{% endif %}{% if filters.price_max %}&price_max={{ filters.price_max }}{% endif %}{% if filters.mileage_max %}&mileage_max={{ filters.mileage_max }}{% endif %}{% if filters.year_min %}&year_min={{ filters.year_min }}{% endif %}{% if filters.country %}&country={{ filters.country }}{% endif %}{% if filters.search %}&search={{ filters.search }}{% endif %}"
    hx-target="#listings-table"
    hx-push-url="true"
>{{ label }}{{ sort_indicator | safe }}</th>
{% endmacro %}

{% if listings %}
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                {{ sort_header('price', 'Price', 'right') }}
                {{ sort_header('mileage', 'Mileage', 'right') }}
                {{ sort_header('score', 'Score', 'right') }}
                <th>Qualified</th>
                <th>Source</th>
                {{ sort_header('first_seen', 'Added') }}
            </tr>
        </thead>
        <tbody>
            {% for listing in listings %}
            {% include "components/listing_row.html" %}
            {% endfor %}
        </tbody>
    </table>
</div>

{% include "components/pagination.html" %}

{% else %}
<div class="empty-state">
    <p>No listings found matching your criteria.</p>
</div>
{% endif %}
