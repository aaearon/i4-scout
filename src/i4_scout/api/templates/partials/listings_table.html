{% macro sort_header(field, label, align='left') %}
{% set is_active = filters.sort_by == field %}
{% set new_order = 'asc' if (is_active and filters.sort_order == 'desc') else 'desc' %}
{% set sort_indicator = '' %}
{% if is_active %}
    {% if filters.sort_order == 'asc' %}
        {% set sort_indicator = ' &#9650;' %}
    {% else %}
        {% set sort_indicator = ' &#9660;' %}
    {% endif %}
{% endif %}
{# Use namespace to allow modification inside loops #}
{% set ns = namespace(query='sort_by=' ~ field ~ '&sort_order=' ~ new_order ~ '&limit=' ~ limit ~ '&offset=0') %}
{% if filters.source %}{% set ns.query = ns.query ~ '&source=' ~ filters.source %}{% endif %}
{% if filters.qualified_only %}{% set ns.query = ns.query ~ '&qualified_only=true' %}{% endif %}
{% if filters.has_issue %}{% set ns.query = ns.query ~ '&has_issue=true' %}{% endif %}
{% if filters.has_price_change %}{% set ns.query = ns.query ~ '&has_price_change=true' %}{% endif %}
{% if filters.min_score %}{% set ns.query = ns.query ~ '&min_score=' ~ filters.min_score %}{% endif %}
{% if filters.price_min %}{% set ns.query = ns.query ~ '&price_min=' ~ filters.price_min %}{% endif %}
{% if filters.price_max %}{% set ns.query = ns.query ~ '&price_max=' ~ filters.price_max %}{% endif %}
{% if filters.mileage_max %}{% set ns.query = ns.query ~ '&mileage_max=' ~ filters.mileage_max %}{% endif %}
{% if filters.year_min %}{% set ns.query = ns.query ~ '&year_min=' ~ filters.year_min %}{% endif %}
{% if filters.country %}{% set ns.query = ns.query ~ '&country=' ~ filters.country %}{% endif %}
{% if filters.search %}{% set ns.query = ns.query ~ '&search=' ~ filters.search %}{% endif %}
{% if filters.has_options %}{% for opt in filters.has_options %}{% set ns.query = ns.query ~ '&has_option=' ~ (opt | urlencode) %}{% endfor %}{% endif %}
{% if filters.options_match %}{% set ns.query = ns.query ~ '&options_match=' ~ filters.options_match %}{% endif %}
<th
    class="sortable-header {% if is_active %}sort-active{% endif %}"
    style="cursor: pointer; {% if align == 'right' %}text-align: right;{% endif %}"
    hx-get="/partials/listings?{{ ns.query }}"
    hx-target="#listings-table"
    hx-push-url="/listings?{{ ns.query }}"
>{{ label }}{{ sort_indicator | safe }}</th>
{% endmacro %}

{% if listings %}
<div class="pagination-info-top">
    Showing {{ offset + 1 }} - {{ offset + count }} of {{ total }} listings
</div>
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th style="width: 2.5rem;">
                    <input type="checkbox" id="select-all" title="Select all visible">
                </th>
                <th style="width: 1.5rem;" title="Favorites"></th>
                <th>ID</th>
                <th>Title</th>
                {{ sort_header('price', 'Price', 'right') }}
                {{ sort_header('mileage', 'Mileage', 'right') }}
                {{ sort_header('score', 'Score', 'right') }}
                <th>Qualified</th>
                <th>First Reg</th>
                {{ sort_header('first_seen', 'Added') }}
            </tr>
        </thead>
        <tbody>
            {% for listing in listings %}
            {% include "components/listing_row.html" %}
            {% endfor %}
        </tbody>
    </table>
</div>

{% include "components/pagination.html" %}

{% else %}
<div class="empty-state">
    <p>No listings found matching your criteria.</p>
</div>
{% endif %}
